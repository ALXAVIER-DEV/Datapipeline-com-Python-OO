

DECLARE @c_dStartDate VARCHAR (10) = '2023-09-01';
DECLARE @c_dEndDate  VARCHAR(10) = '2023-10-31';
WITH MTL AS (
    SELECT CAST(CAST(ESIT.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT) AS INVENTORY_ITEM_ID
    ,CAST(CAST(ESIT.ORGANIZATION_ID AS FLOAT) AS BIGINT) AS ORGANIZATION_ID
    ,EIRB.CROSS_REFERENCE , ESIT.DESCRIPTION                
FROM 
FUSION.OCI_EGP_SYSTEM_ITEMS_B ESIB
INNER JOIN
FUSION.OCI_EGP_SYSTEM_ITEMS_TL ESIT
ON (
    CAST(CAST(ESIB.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT) = CAST(CAST(ESIT.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT)
    AND
    CAST(CAST(ESIB.ORGANIZATION_ID AS FLOAT) AS BIGINT) = CAST(CAST(ESIT.ORGANIZATION_ID AS FLOAT) AS BIGINT)
)
INNER JOIN
FUSION.OCI_EGP_ITEM_RELATIONSHIPS_B EIRB
ON (
    CAST(CAST(ESIT.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT) = CAST(CAST(EIRB.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT)
    --AND
    --ESIT.ORGANIZATION_ID = EIRB.ORGANIZATION_ID
    
)
),

--VIEW_ODPV_RECEBIMENTO_PF
--WITH 
RECEBIMENTO_PF AS (
  SELECT  
    'ODPV'                                                             AS MNEMONICO
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN 'ODPV'
            WHEN '05'   THEN 'BBDENTAL'
        ELSE 'OUTRO'
        END                                                     +
      CASE GCC.SEGMENT1
            WHEN '01'   THEN '30194-9'
            WHEN '05'   THEN '41941-9'
        ELSE 'OUTRO'
        END                                                     +
      '4'                                                       +
      HCA.ACCOUNT_NUMBER                                        +
      REPLACE(REPLACE(ACRA.RECEIPT_NUMBER,CHAR(10),''),CHAR(13),'') +                 -- VERIFICAR A FUNÇÃO DE REPLACE
      COALESCE(CAST(MSI.CROSS_REFERENCE AS NVARCHAR),'')   +
      '1'                                                       +
      '-' + GCC.SEGMENT4                                        +
      '-' + FORMAT(CONVERT(DATETIME,ACRHA.GL_DATE), 'ddMMyyyy') +
      '-RE-PF'                                                        AS INSTID
    ,REPLACE(REPLACE(ACRA.RECEIPT_NUMBER,CHAR(10),''),CHAR(13),'')    AS FATURA       -- VERIFICAR A FUNÇÃO DE REPLACE
    ,TE.CD_EMPRESA                                               +
      COALESCE(CAST(MSI.CROSS_REFERENCE AS NVARCHAR),'')         +
      TA.NR_ATENDIMENTO                                               AS CONTRATO_PLANO
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN 'ODPV'
            WHEN '05'   THEN 'BBDT'
        ELSE 'OUTRO'
        END                                                           AS CD_COMPANHIA
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN '30194-9'
            WHEN '05'   THEN '41941-9'
        ELSE 'OUTRO'
        END                                                           AS CD_ENTIDADE
    ,'4'                                                              AS CD_RAMO 
    ,''                                                               AS CD_SUBRAMO 
    ,COALESCE(CAST(MSI.CROSS_REFERENCE AS NVARCHAR),'')               AS CD_PRODUTO
    ,'ODONTOLOGICO'                                                   AS NM_RAMO
    ,''                                                               AS NM_SUBRAMO
    ,MSI.DESCRIPTION                                                  AS NM_PRODUTO
    ,FORMAT(CONVERT(DATETIME,ACRHA.GL_DATE), 'yyyy')                                    AS ANO_CONTABIL
    ,FORMAT(CONVERT(DATETIME,ACRHA.GL_DATE), 'MM')                                      AS MES_CONTABIL
    ,'RECEBIMENTO'                                                    AS TIPO_MOVIMENTO
    ,GCC.SEGMENT4                                                     AS CD_CONTA_CONTABIL
    ,CONCAT(HCA.ACCOUNT_NUMBER,'0')                                   AS ENDOSSO
    ,ROUND((ARAA.AMOUNT_APPLIED / COUNT(rctla.inventory_item_id) over ( PARTITION BY rctla.customer_trx_id, ACRHA.GL_DATE)), 2) AS VALOR_MOVIMENTO
    ,FORMAT(CONVERT(DATETIME,ACRHA.GL_DATE),'ddMMyyyy')               AS DT_MOVIMENTO
    ,CASE
          WHEN TE.ID_EMPRESA_PF = 'S' THEN 'PF'
          WHEN UPPER(ME.NM_MARCA) LIKE UPPER('%PME%') THEN 'PME'
          WHEN (
                  ME.CD_EMPRESA_GESTORA = '15' 
                  AND 
                  UPPER(TRIM(ME.NM_MARCA)) = 'BBDENTAL' 
                  AND 
                  UPPER(CEL.NM_CELULA) LIKE UPPER('Núcleo de Atendimento PJ%')                                
                  ) THEN 'PME'           
          ELSE
              'CORP'
      END                                                             AS PORTFOLIO
    ,TE.CD_EMPRESA_GRSOC                                              AS GRUPO_GERENCIAL
    ,TE.CD_EMPRESA                                                    AS CD_EMPRESA 
    ,TP.ID_RISCO_CEDIDO                                               AS RISCO_CEDIDO
    ,REPLACE(TE.CD_EMPRESA_CLI_OPERADORA, 'ODSY', '')                 AS CD_CLI_OPERADORA
FROM [FUSION].[OCI_RA_CUSTOMER_TRX_ALL] AS RCTA
  INNER JOIN [FUSION].[OCI_HZ_CUST_ACCOUNTS] AS HCA ON (
    --HCA.CUST_ACCOUNT_ID = RCTA.BILL_TO_CUSTOMER_ID
	 CAST(CAST(HCA.CUST_ACCOUNT_ID AS FLOAT) AS BIGINT) = CAST(CAST(RCTA.BILL_TO_CUSTOMER_ID AS FLOAT) AS BIGINT)
  )
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_ASSOCIADO] AS TA ON (
    TRIM(HCA.ACCOUNT_NUMBER) = TRIM(TA.CD_ASSOCIADO)                   
  )
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_EMPRESA] AS TE ON (
        TE.CD_EMPRESA = CAST(TA.CD_EMPRESA AS INT)                         -- MODIFICADO   INT   NVARCHAR(6)
  )
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_MARCA_EMPRESA] AS ME ON (
    ME.CD_MARCA  = TE.CD_MARCA
    AND
    ME.CD_EMPRESA_GESTORA IN (1, 15)
  )
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_CELULA] AS CEL ON (
    CAST(CEL.CD_CELULA AS INT) = TE.CD_CELULA                             -- MODIFICADO   DECIMAL(38,18)  INT
  )
  INNER JOIN [FUSION].[OCI_RA_CUSTOMER_TRX_LINES_ALL] AS RCTLA ON (
    RCTA.CUSTOMER_TRX_ID = RCTLA.CUSTOMER_TRX_ID  -- MODIFICADO   NUMERIC(15,0)   DECIMAL(38,18)
  )
  INNER JOIN [FUSION].[OCI_AR_PAYMENT_SCHEDULES_ALL] AS APSA ON (
    RCTA.CUSTOMER_TRX_ID = APSA.CUSTOMER_TRX_ID   -- MODIFICADO   NUMERIC(15,0)  DECIMAL(11,2)
    AND 
    APSA.CLASS = 'INV'  
  )
  --INNER JOIN [FUSION].[AR_AR_RECEIVABLE_APPLICATIONS_ALL] AS ARAA ON (
	INNER JOIN [FUSION].[OCI_AR_RECEIVABLE_APPLICATIONS_ALL] AS ARAA ON(
    CAST(CAST(ARAA.APPLIED_PAYMENT_SCHEDULE_ID AS FLOAT ) AS BIGINT) = CAST(CAST(APSA.PAYMENT_SCHEDULE_ID AS FLOAT) AS BIGINT)
    AND
    ARAA.STATUS = 'APP' 
    AND 
    ARAA.DISPLAY = 'Y'
  )
  --INNER JOIN [FUSION].[AR_AR_CASH_RECEIPTS_ALL] AS ACRA ON (
	INNER JOIN [FUSION].[OCI_AR_CASH_RECEIPTS_ALL] AS ACRA ON (
    CAST(CAST(ACRA.CASH_RECEIPT_ID AS FLOAT) AS BIGINT) = CAST(CAST(ARAA.CASH_RECEIPT_ID AS FLOAT) AS BIGINT) 
  )
  --INNER JOIN [FUSION].[AR_AR_CASH_RECEIPT_HISTORY_ALL] AS ACRHA ON (
	INNER JOIN [FUSION].[OCI_AR_CASH_RECEIPT_HISTORY_ALL] AS ACRHA ON (
    CAST(CAST(ACRA.CASH_RECEIPT_ID AS FLOAT) AS BIGINT) = CAST(CAST(ACRHA.CASH_RECEIPT_ID AS FLOAT) AS BIGINT)
    AND 
    ACRHA.FIRST_POSTED_RECORD_FLAG = 'Y'
  )
  --INNER JOIN [FUSION].[AR_AR_RECEIPT_METHOD_ACCOUNTS_ALL] AS ARMAA ON (
	INNER JOIN [FUSION].[OCI_AR_RECEIPT_METHOD_ACCOUNTS_ALL] AS ARMAA ON (
    CAST(CAST(ACRA.REMITTANCE_BANK_ACCOUNT_ID AS FLOAT) AS BIGINT) = CAST(CAST(ARMAA.BANK_ACCOUNT_ID AS FLOAT) AS BIGINT)
    AND
    ACRA.RECEIPT_METHOD_ID = ARMAA.RECEIPT_METHOD_ID
  )
  INNER JOIN [FUSION].[OCI_GL_CODE_COMBINATIONS] AS GCC ON (
    ARMAA.CASH_CCID = GCC.CODE_COMBINATION_ID  
  )
  INNER JOIN [FUSION].[OCI_RA_CUST_TRX_TYPES_ALL] AS RCTTA ON (
    --RCTTA.CUST_TRX_TYPE_ID = RCTA.CUST_TRX_TYPE_ID
	CAST(CAST(RCTTA.CUST_TRX_TYPE_SEQ_ID AS FLOAT) AS BIGINT) = CAST(CAST(RCTA.CUST_TRX_TYPE_SEQ_ID AS FLOAT) AS BIGINT) 
    AND 
    RCTTA.TYPE = 'INV' 
  )
  INNER JOIN [FUSION].[OCI_HZ_CUST_SITE_USES_ALL] AS HCSUA ON (
    RCTA.BILL_TO_SITE_USE_ID = HCSUA.SITE_USE_ID 
  )
  INNER JOIN [FUSION].[OCI_HZ_CUST_ACCT_SITES_ALL] AS HCASA ON (
    HCSUA.CUST_ACCT_SITE_ID = HCASA.CUST_ACCT_SITE_ID 
  )
    INNER JOIN [FUSION].[OCI_HZ_PARTY_SITES] AS RA ON (
    CAST(CAST(HCASA.PARTY_SITE_ID AS FLOAT) AS BIGINT) = CAST(CAST(RA.PARTY_SITE_ID AS FLOAT) AS BIGINT)
    AND 
    HCA.ATTRIBUTE_CATEGORY = 'DCMS - PJ'--RA.GLOBAL_ATTRIBUTE2 = '2'
    AND
    CAST(CAST(HCASA.SET_ID AS FLOAT) AS BIGINT)   IN (300000011186631,300000011186633) --RA.PARTY_SITE_ID IN( 104, 182)
	)
--   INNER JOIN [FUSION].[OCI_HZ_PARTY_SITES] AS RA ON (
--     HCASA.PARTY_SITE_ID = RA.PARTY_SITE_ID
--     AND 
--     RA.GLOBAL_ATTRIBUTE2 = '1'
--     AND
--     RA.ORG_ID IN( 104, 182)
--   )
  INNER JOIN MTL /*[FUSION].[OCI_EGP_ITEM_RELATIONSHIPS_B]*/ AS MSI ON  (
      CAST(CAST(MSI.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT) = CAST(CAST(RCTLA.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT)--MSI.INVENTORY_ITEM_ID = CAST(RCTLA.INVENTORY_ITEM_ID AS NUMERIC(18,0))   -- MODIFICADO   NUMERIC(18,0)   DECIMAL(38,18)
      AND 
      CAST(CAST(MSI.ORGANIZATION_ID AS FLOAT) AS BIGINT) = 300000011226455 -- 107
      AND
      SUBSTRING(MSI.CROSS_REFERENCE,1,1) in ('0','1','2','3','4','5','6','7','8','9')
	)
--   INNER JOIN [FUSION].[APPS_MTL_SYSTEM_ITEMS_B] AS MSI ON (
--       MSI.INVENTORY_ITEM_ID = CAST(RCTLA.INVENTORY_ITEM_ID AS NUMERIC(18,0))   -- MODIFICADO   NUMERIC(18,0)   DECIMAL(38,18)
--       AND 
--       MSI.ORGANIZATION_ID = 107
--       AND
--       SUBSTRING(MSI.CROSS_REFERENCE,1,1) in ('0','1','2','3','4','5','6','7','8','9')
--   )                                                                            -- VERIFICAR SE O CORRETO SERIA LEFT OU INNER
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_PLANO] AS TP ON (
        CAST(REPLICATE('0', 11 -LEN(TP.CD_PLANO))+RTrim(TP.CD_PLANO) AS NVARCHAR) = MSI.CROSS_REFERENCE    -- MODIFICADO INT    NVARCHAR(40)
  )
  WHERE
    CAST(CAST(RCTA.ORG_ID AS FLOAT) AS BIGINT) IN(300000005902285, 300000005902311)  --( 104, 182)
    AND
    CAST(CAST(RCTA.PREVIOUS_CUSTOMER_TRX_ID AS FLOAT) AS BIGINT) IS NOT NULL
 AND 
     FORMAT(CONVERT(DATETIME,ACRHA.GL_DATE), 'yyyy-MM-dd')  BETWEEN FORMAT(CONVERT(DATETIME,@c_dStartDate), 'yyyy-MM-dd')
                                            AND FORMAT(CONVERT(DATETIME,@c_dEndDate) ,'yyyy-MM-dd') -- 92160
											)
--     RCTA.ORG_ID IN( 104, 182)
--     AND
--     RCTA.PREVIOUS_CUSTOMER_TRX_ID IS NULL
--  AND 
--      FORMAT(ACRHA.GL_DATE, 'yyyy-MM-dd') BETWEEN CAST(@c_dStartDate AS DATE)
--                                             AND CAST(@c_dEndDate AS DATE) 
-- )
INSERT INTO IFRS17.TB_ODPV_BBDT_PREMIO_MOVIMENTO_HML
SELECT MNEMONICO, INSTID, FATURA, CONTRATO_PLANO, CD_COMPANHIA, CD_ENTIDADE, CD_RAMO, CD_SUBRAMO, CD_PRODUTO, NM_RAMO, NM_SUBRAMO, NM_PRODUTO, ANO_CONTABIL, MES_CONTABIL, TIPO_MOVIMENTO, CD_CONTA_CONTABIL, ENDOSSO, CAST(SUM(VALOR_MOVIMENTO) AS DECIMAL(11,2)) AS VALOR_MOVIMENTO, DT_MOVIMENTO, PORTFOLIO, GRUPO_GERENCIAL, CD_EMPRESA, CASE WHEN RISCO_CEDIDO = 'S' THEN 'Y' ELSE 'N' END AS RISCO_CEDIDO, CD_CLI_OPERADORA
  FROM RECEBIMENTO_PF     
GROUP BY MNEMONICO, INSTID, FATURA, CONTRATO_PLANO, CD_COMPANHIA, CD_ENTIDADE, CD_RAMO, CD_SUBRAMO, CD_PRODUTO, NM_RAMO, NM_SUBRAMO, NM_PRODUTO, ANO_CONTABIL, MES_CONTABIL, TIPO_MOVIMENTO, CD_CONTA_CONTABIL, ENDOSSO, DT_MOVIMENTO, PORTFOLIO, GRUPO_GERENCIAL, CD_EMPRESA, CASE WHEN RISCO_CEDIDO = 'S' THEN 'Y' ELSE 'N' END, CD_CLI_OPERADORA
;
--VIEW_ODPV_RECEBIMENTO_PJ
WITH 
RECEBIMENTO_PJ AS (
  SELECT  
    'ODPV'                                                     AS MNEMONICO
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN 'ODPV'
            WHEN '05'   THEN 'BBDENTAL'
        ELSE 'OUTRO'
        END                                                     +
      CASE GCC.SEGMENT1
            WHEN '01'   THEN '30194-9'
            WHEN '05'   THEN '41941-9'
        ELSE 'OUTRO'
        END                                                     +
      '4'                                                       +
      HCA.ACCOUNT_NUMBER                                        +
      REPLACE(REPLACE(ACRA.RECEIPT_NUMBER,CHAR(10),''),CHAR(13),'') +                 -- VERIFICAR A FUNÇÃO DE REPLACE
      COALESCE(CAST(MSI.CROSS_REFERENCE AS NVARCHAR),'')        +
      '1'                                                       +
      '-' + GCC.SEGMENT4                                        +
      '-' + FORMAT(CONVERT(DATETIME,ACRHA.GL_DATE), 'ddMMyyyy') +
      '-RE-PJ'                                                        AS INSTID
    ,REPLACE(REPLACE(ACRA.RECEIPT_NUMBER,CHAR(10),''),CHAR(13),'')    AS FATURA       -- VERIFICAR A FUNÇÃO DE REPLACE
    ,CAST(TE.CD_EMPRESA          AS NVARCHAR)                   +
    COALESCE(CAST(MSI.CROSS_REFERENCE AS NVARCHAR),'')              AS CONTRATO_PLANO
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN 'ODPV'
            WHEN '05'   THEN 'BBDT'
        ELSE 'OUTRO'
        END                                                           AS CD_COMPANHIA
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN '30194-9'
            WHEN '05'   THEN '41941-9'
        ELSE 'OUTRO'
        END                                                           AS CD_ENTIDADE
    ,'4'                                                              AS CD_RAMO 
    ,''                                                               AS CD_SUBRAMO 
    ,COALESCE(CAST(MSI.CROSS_REFERENCE AS NVARCHAR),'')               AS CD_PRODUTO
    ,'ODONTOLOGICO'                                                   AS NM_RAMO
    ,''                                                               AS NM_SUBRAMO
    ,MSI.DESCRIPTION                                                  AS NM_PRODUTO
    ,FORMAT(CONVERT(DATETIME,ACRHA.GL_DATE), 'yyyy')                  AS ANO_CONTABIL
    ,FORMAT(CONVERT(DATETIME,ACRHA.GL_DATE), 'MM')                    AS MES_CONTABIL
    ,'RECEBIMENTO'                                                    AS TIPO_MOVIMENTO
    ,GCC.SEGMENT4                                                     AS CD_CONTA_CONTABIL
    ,CONCAT(HCA.ACCOUNT_NUMBER,'0')                                   AS ENDOSSO
    ,ROUND((ARAA.AMOUNT_APPLIED / COUNT(rctla.inventory_item_id) over ( PARTITION BY rctla.customer_trx_id, ACRHA.GL_DATE)), 2) AS VALOR_MOVIMENTO
    ,FORMAT(CONVERT(DATETIME,ACRHA.GL_DATE),'ddMMyyyy')               AS DT_MOVIMENTO
    ,CASE
          WHEN TE.ID_EMPRESA_PF = 'S' THEN 'PF'
          WHEN UPPER(ME.NM_MARCA) LIKE UPPER('%PME%') THEN 'PME'
          WHEN (
                  ME.CD_EMPRESA_GESTORA = '15' 
                  AND 
                  UPPER(TRIM(ME.NM_MARCA)) = 'BBDENTAL' 
                  AND 
                  UPPER(CEL.NM_CELULA) LIKE UPPER('Núcleo de Atendimento PJ%')                                
                  ) THEN 'PME'           
          ELSE
              'CORP'
      END                                                             AS PORTFOLIO
    ,TE.CD_EMPRESA_GRSOC                                              AS GRUPO_GERENCIAL
    ,TE.CD_EMPRESA                                                    AS CD_EMPRESA 
    ,TP.ID_RISCO_CEDIDO                                               AS RISCO_CEDIDO
    ,REPLACE(TE.CD_EMPRESA_CLI_OPERADORA, 'ODSY', '')                 AS CD_CLI_OPERADORA
/*    ,ARAA.STATUS
    ,ARAA.APPLIED_PAYMENT_SCHEDULE_ID
    ,ARAA.DISPLAY
    ,ACRHA.FIRST_POSTED_RECORD_FLAG
    ,ARAA.CASH_RECEIPT_ID
    ,ARAA.AMOUNT_APPLIED */
FROM [FUSION].[OCI_RA_CUSTOMER_TRX_ALL] AS RCTA
  INNER JOIN [FUSION].[OCI_HZ_CUST_ACCOUNTS] AS HCA ON (
    HCA.CUST_ACCOUNT_ID = RCTA.BILL_TO_CUSTOMER_ID
  )
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_EMPRESA] AS TE ON (
    TRIM(HCA.ACCOUNT_NUMBER) = CAST(REPLICATE('0', 6 -LEN(TE.CD_EMPRESA ))+RTrim(TE.CD_EMPRESA) AS NVARCHAR)      --MODIFICADO  nvarchar(30)    int
  )
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_MARCA_EMPRESA] AS ME ON (
    ME.CD_MARCA  = TE.CD_MARCA
    AND
    ME.CD_EMPRESA_GESTORA IN (1, 15)
  )
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_CELULA] AS CEL ON (
    CEL.CD_CELULA = TE.CD_CELULA                             -- MODIFICADO   DECIMAL(38,18)  INT
  )
  INNER JOIN [FUSION].[OCI_RA_CUSTOMER_TRX_LINES_ALL] AS RCTLA ON (
    CAST(CAST(RCTA.CUSTOMER_TRX_ID AS FLOAT) AS BIGINT) = CAST(CAST(RCTLA.CUSTOMER_TRX_ID AS FLOAT) AS BIGINT) -- MODIFICADO   NUMERIC(15,0)   DECIMAL(38,18)
  )
  INNER JOIN [FUSION].[OCI_AR_PAYMENT_SCHEDULES_ALL] AS APSA ON (
    CAST(CAST(RCTA.CUSTOMER_TRX_ID AS FLOAT) AS BIGINT) = CAST(CAST(APSA.CUSTOMER_TRX_ID AS FLOAT) AS BIGINT)  -- MODIFICADO   NUMERIC(15,0)  DECIMAL(11,2)
    AND 
    APSA.CLASS = 'INV'  
  )
  INNER JOIN --[FUSION].[AR_AR_RECEIVABLE_APPLICATIONS_ALL] AS ARAA ON (
	[FUSION].[OCI_AR_RECEIVABLE_APPLICATIONS_ALL] AS ARAA ON (
    CAST(CAST(ARAA.APPLIED_PAYMENT_SCHEDULE_ID AS FLOAT) AS BIGINT) = CAST(CAST(APSA.PAYMENT_SCHEDULE_ID AS FLOAT) AS BIGINT)    -- MODIFICADO   NUMERIC(15,0)  DECIMAL(11,2)
    AND
    ARAA.STATUS = 'APP' 
    AND 
    ARAA.DISPLAY = 'Y'
  )
  --INNER JOIN [FUSION].[AR_AR_CASH_RECEIPTS_ALL] AS ACRA ON (
	INNER JOIN [FUSION].[OCI_AR_CASH_RECEIPTS_ALL] AS ACRA ON (
    ACRA.CASH_RECEIPT_ID = ARAA.CASH_RECEIPT_ID  
  )
--   INNER JOIN [FUSION].[AR_AR_CASH_RECEIPT_HISTORY_ALL] AS ACRHA ON (
	INNER JOIN [FUSION].[OCI_AR_CASH_RECEIPT_HISTORY_ALL] AS ACRHA ON (
    ACRA.CASH_RECEIPT_ID = ACRHA.CASH_RECEIPT_ID
    AND 
    ACRHA.FIRST_POSTED_RECORD_FLAG = 'Y'
  )
  --INNER JOIN [FUSION].[AR_AR_RECEIPT_METHOD_ACCOUNTS_ALL] AS ARMAA ON (
	INNER JOIN [FUSION].[OCI_AR_RECEIPT_METHOD_ACCOUNTS_ALL] AS ARMAA ON (
    ACRA.REMITTANCE_BANK_ACCOUNT_ID = ARMAA.BANK_ACCOUNT_ID
    AND
    ACRA.RECEIPT_METHOD_ID = ARMAA.RECEIPT_METHOD_ID
  )
  INNER JOIN [FUSION].[OCI_GL_CODE_COMBINATIONS] AS GCC ON (
    ARMAA.CASH_CCID = GCC.CODE_COMBINATION_ID  
  )
  INNER JOIN [FUSION].[OCI_RA_CUST_TRX_TYPES_ALL] AS RCTTA ON (
    RCTTA.CUST_TRX_TYPE_SEQ_ID = RCTA.CUST_TRX_TYPE_SEQ_ID
    AND 
    RCTTA.TYPE = 'INV' 
  )
  INNER JOIN [FUSION].[OCI_HZ_CUST_SITE_USES_ALL] AS HCSUA ON (
    RCTA.BILL_TO_SITE_USE_ID = HCSUA.SITE_USE_ID 
  )
  INNER JOIN [FUSION].[OCI_HZ_CUST_ACCT_SITES_ALL] AS HCASA ON (
    HCSUA.CUST_ACCT_SITE_ID = HCASA.CUST_ACCT_SITE_ID 
  )
    INNER JOIN [FUSION].[OCI_HZ_PARTY_SITES] AS RA ON (
    CAST(CAST(HCASA.PARTY_SITE_ID AS FLOAT) AS BIGINT) = CAST(CAST(RA.PARTY_SITE_ID AS FLOAT) AS BIGINT)
    AND 
    HCA.ATTRIBUTE_CATEGORY = 'DCMS - PJ'--RA.GLOBAL_ATTRIBUTE2 = '2'
    AND
    CAST(CAST(HCASA.SET_ID AS FLOAT) AS BIGINT)   IN (300000011186631,300000011186633) --RA.PARTY_SITE_ID IN( 104, 182)
  )
--   INNER JOIN [FUSION].[OCI_HZ_PARTY_SITES] AS RA ON (
--     HCASA.PARTY_SITE_ID = RA.PARTY_SITE_ID
--     AND 
--     RA.GLOBAL_ATTRIBUTE2 = '2'
--     AND
--     RA.ORG_ID IN( 104, 182)
--   )
   INNER JOIN MTL /*[FUSION].[OCI_EGP_ITEM_RELATIONSHIPS_B]*/ AS MSI ON  (
      CAST(CAST(MSI.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT) = CAST(CAST(RCTLA.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT)--MSI.INVENTORY_ITEM_ID = CAST(RCTLA.INVENTORY_ITEM_ID AS NUMERIC(18,0))   -- MODIFICADO   NUMERIC(18,0)   DECIMAL(38,18)
      AND 
      CAST(CAST(MSI.ORGANIZATION_ID AS FLOAT) AS BIGINT) = 300000011226455 -- 107
      AND
      SUBSTRING(MSI.CROSS_REFERENCE,1,1) in ('0','1','2','3','4','5','6','7','8','9')
  )
--   INNER JOIN [FUSION].[APPS_MTL_SYSTEM_ITEMS_B] AS MSI ON (
--       MSI.INVENTORY_ITEM_ID = CAST(RCTLA.INVENTORY_ITEM_ID AS NUMERIC(18,0))   -- MODIFICADO   NUMERIC(18,0)   DECIMAL(38,18)
--       AND 
--       MSI.ORGANIZATION_ID = 107
--       AND
--       SUBSTRING(MSI.CROSS_REFERENCE,1,1) in ('0','1','2','3','4','5','6','7','8','9')
--   )                                                                            -- VERIFICAR SE O CORRETO SERIA LEFT OU INNER
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_PLANO] AS TP ON (
        CAST(REPLICATE('0', 11 -LEN(TP.CD_PLANO))+RTrim(TP.CD_PLANO) AS NVARCHAR) = MSI.CROSS_REFERENCE    -- MODIFICADO INT    NVARCHAR(40)
  )
  WHERE
     CAST(CAST(RCTA.ORG_ID AS FLOAT) AS BIGINT) IN(300000005902285, 300000005902311)  --( 104, 182)--RCTA.ORG_ID IN( 104, 182)
    AND
    CAST(CAST(RCTA.PREVIOUS_CUSTOMER_TRX_ID AS FLOAT) AS BIGINT) IS NOT NULL--RCTA.PREVIOUS_CUSTOMER_TRX_ID IS NULL
--    AND
--    REPLACE(REPLACE(RECEIPT_NUMBER,CHAR(10),''),CHAR(13),'') = '387506'
 AND 
     FORMAT(CONVERT(DATETIME,ACRHA.GL_DATE), 'yyyy-MM-dd') BETWEEN FORMAT(CONVERT(DATETIME,@c_dStartDate),'yyyy-MM-dd')
	  AND FORMAT(CONVERT(DATETIME,@c_dEndDate),'yyyy-MM-dd') 
)
INSERT INTO IFRS17.TB_ODPV_BBDT_PREMIO_MOVIMENTO_HML
SELECT MNEMONICO, INSTID, FATURA, CONTRATO_PLANO, CD_COMPANHIA, CD_ENTIDADE, CD_RAMO, CD_SUBRAMO, CD_PRODUTO, NM_RAMO, NM_SUBRAMO, NM_PRODUTO, ANO_CONTABIL, MES_CONTABIL, TIPO_MOVIMENTO, CD_CONTA_CONTABIL, ENDOSSO, CAST(SUM(VALOR_MOVIMENTO) AS DECIMAL(11,2)) AS VALOR_MOVIMENTO, DT_MOVIMENTO, PORTFOLIO, GRUPO_GERENCIAL, CD_EMPRESA, CASE WHEN RISCO_CEDIDO = 'S' THEN 'Y' ELSE 'N' END AS RISCO_CEDIDO, CD_CLI_OPERADORA
  FROM RECEBIMENTO_PJ     
GROUP BY MNEMONICO, INSTID, FATURA, CONTRATO_PLANO, CD_COMPANHIA, CD_ENTIDADE, CD_RAMO, CD_SUBRAMO, CD_PRODUTO, NM_RAMO, NM_SUBRAMO, NM_PRODUTO, ANO_CONTABIL, MES_CONTABIL, TIPO_MOVIMENTO, CD_CONTA_CONTABIL, ENDOSSO, DT_MOVIMENTO, PORTFOLIO, GRUPO_GERENCIAL, CD_EMPRESA, CASE WHEN RISCO_CEDIDO = 'S' THEN 'Y' ELSE 'N' END, CD_CLI_OPERADORA
;