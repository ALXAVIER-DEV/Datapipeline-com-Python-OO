--VIEW_ODPV_CANCELAMENTO_PJ
WITH MTL AS (
    SELECT CAST(CAST(ESIT.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT) AS INVENTORY_ITEM_ID
    ,CAST(CAST(ESIT.ORGANIZATION_ID AS FLOAT) AS BIGINT) AS ORGANIZATION_ID
    ,EIRB.CROSS_REFERENCE , ESIT.DESCRIPTION
FROM 
FUSION.OCI_EGP_SYSTEM_ITEMS_B ESIB
INNER JOIN
FUSION.OCI_EGP_SYSTEM_ITEMS_TL ESIT
ON (
    ESIB.INVENTORY_ITEM_ID = ESIT.INVENTORY_ITEM_ID
    AND
    ESIB.ORGANIZATION_ID = ESIT.ORGANIZATION_ID
)
INNER JOIN
FUSION.OCI_EGP_ITEM_RELATIONSHIPS_B EIRB
ON (
    ESIT.INVENTORY_ITEM_ID = EIRB.INVENTORY_ITEM_ID
    --AND
    --ESIT.ORGANIZATION_ID = EIRB.ORGANIZATION_ID
    
))
--SELECT DISTINCT SUBSTRING(CROSS_REFERENCE,1,1) , DESCRIPTION FROM MTL
INSERT INTO IFRS17.TB_ODPV_BBDT_PREMIO_MOVIMENTO_HML
SELECT  
    'ODPV'                                                      AS MNEMONICO
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN 'ODPV'
            WHEN '05'   THEN 'BBDENTAL'
        ELSE 'OUTRO'
        END                                                     +
      CASE GCC.SEGMENT1
            WHEN '01'   THEN '30194-9'
            WHEN '05'   THEN '41941-9'
        ELSE 'OUTRO'

        END                                                                  +
      '4'                                                                    +
      HCA.ACCOUNT_NUMBER                                                     +
      RCTA.TRX_NUMBER                                                        +
      COALESCE(CAST(MSI.CROSS_REFERENCE AS NVARCHAR),'')                     +
      COALESCE(RCTLA.ATTRIBUTE14,'')                                         +
      '-' + GCC.SEGMENT4                                                     +
      '-' + FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'ddMMyyyy')            +
      '-CAN-PJ'                                                       AS INSTID
      ,RCTA.TRX_NUMBER                                                AS FATURA
      ,CAST(TE.CD_EMPRESA          AS NVARCHAR)                              +
      COALESCE(CAST(MSI.CROSS_REFERENCE AS NVARCHAR),'')    AS CONTRATO_PLANO
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN 'ODPV'
            WHEN '05'   THEN 'BBDT'
        ELSE 'OUTRO'
        END                                                           AS CD_COMPANHIA
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN '30194-9'
            WHEN '05'   THEN '41941-9'
        ELSE 'OUTRO'
        END                                                           AS CD_ENTIDADE
    ,'4'                                                              AS CD_RAMO 
    ,''                                                               AS CD_SUBRAMO
    ,COALESCE(CAST(MSI.CROSS_REFERENCE AS NVARCHAR),'')                AS CD_PRODUTO
    ,'ODONTOLOGICO'                                                   AS NM_RAMO
    ,''                                                               AS NM_SUBRAMO
    ,MSI.DESCRIPTION                                                  AS NM_PRODUTO
    ,FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'yyyy')                AS ANO_CONTABIL
    ,FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'MM')                  AS MES_CONTABIL
    ,'CANCELAMENTO'                                                   AS TIPO_MOVIMENTO
    ,GCC.SEGMENT4                                                     AS CD_CONTA_CONTABIL
    ,CONCAT(HCA.ACCOUNT_NUMBER,'0')                                   AS ENDOSSO
    ,SUM(CAST(RCTLA.EXTENDED_AMOUNT AS FLOAT))                          AS VALOR_MOVIMENTO
    ,FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE),'ddMMyyyy')             AS DT_MOVIMENTO
    ,CASE
          WHEN TE.ID_EMPRESA_PF = 'S' THEN 'PF'
          WHEN UPPER(ME.NM_MARCA) LIKE UPPER('%PME%') THEN 'PME'
          WHEN (
                  ME.CD_EMPRESA_GESTORA = 15 
                  AND 
                  UPPER(TRIM(ME.NM_MARCA)) = 'BBDENTAL' 
                  AND 
                  UPPER(CEL.NM_CELULA) LIKE UPPER('Núcleo de Atendimento PJ%')                                
                  ) THEN 'PME'           
          ELSE
             'CORP'
      END                                                             AS PORTFOLIO
     ,TE.CD_EMPRESA_GRSOC                                              AS GRUPO_GERENCIAL
     ,TE.CD_EMPRESA                                                    AS CD_EMPRESA 
     ,TP.ID_RISCO_CEDIDO                                               AS RISCO_CEDIDO
     ,REPLACE(TE.CD_EMPRESA_CLI_OPERADORA, 'ODSY', '')                 AS CD_CLI_OPERADORA
  -- --COUNT(1) AS LINHAS
   FROM [FUSION].[OCI_RA_CUSTOMER_TRX_ALL_BKP] AS RCTA
   INNER JOIN [FUSION].[OCI_HZ_CUST_ACCOUNTS] AS HCA ON (
    CAST(CAST(HCA.CUST_ACCOUNT_ID AS FLOAT) AS BIGINT) = CAST(CAST(RCTA.BILL_TO_CUSTOMER_ID AS FLOAT) AS BIGINT)
   ) --12795201
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_EMPRESA] AS TE ON (
    CAST(REPLICATE('0', 6 -LEN(HCA.ACCOUNT_NUMBER ))+RTrim(HCA.ACCOUNT_NUMBER) AS NVARCHAR) = CAST(REPLICATE('0', 6 -LEN(TE.CD_EMPRESA ))+RTrim(TE.CD_EMPRESA) AS NVARCHAR)     --MODIFICADO  nvarchar(30)    int
     
  )--409334
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_MARCA_EMPRESA] AS ME ON (
    ME.CD_MARCA  = TE.CD_MARCA
    AND
    ME.CD_EMPRESA_GESTORA IN (1, 15)
  )--409334
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_CELULA] AS CEL ON (
    CEL.CD_CELULA = TE.CD_CELULA                             -- MODIFICADO   DECIMAL(38,18)  INT
  )--409334
  INNER JOIN [FUSION].[OCI_RA_CUSTOMER_TRX_LINES_ALL] AS RCTLA ON (
    CAST(CAST(RCTA.CUSTOMER_TRX_ID AS FLOAT) AS BIGINT) = CAST(CAST(RCTLA.CUSTOMER_TRX_ID AS FLOAT) AS BIGINT)   -- MODIFICADO   NUMERIC(15,0)   DECIMAL(38,18)
    AND 
    RCTLA.LINE_TYPE = 'LINE'
    AND
    CAST(CAST(RCTLA.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT)  IS NOT NULL
  ) --20035 --2235
  INNER JOIN [FUSION].[OCI_RA_CUST_TRX_LINE_GL_DIST_ALL] AS RCTLGDA ON (
    CAST(CAST(RCTLA.CUSTOMER_TRX_LINE_ID AS FLOAT) AS BIGINT)  = CAST(CAST(RCTLGDA.CUSTOMER_TRX_LINE_ID AS FLOAT) AS BIGINT)
  )--20035 --
  INNER JOIN [FUSION].[OCI_GL_CODE_COMBINATIONS] AS GCC ON (
    CAST(CAST(RCTLGDA.CODE_COMBINATION_ID AS FLOAT)AS BIGINT) = CAST(CAST(GCC.CODE_COMBINATION_ID AS FLOAT) AS BIGINT) -- MODIFICADO   DECIMAL(38,18)  NUMERIC(15,0)   
  )--200435 --11175
  INNER JOIN [FUSION].[OCI_AR_PAYMENT_SCHEDULES_ALL] AS APSA ON (
   CAST(CAST(RCTA.CUSTOMER_TRX_ID AS FLOAT) AS BIGINT) = CAST(CAST(APSA.CUSTOMER_TRX_ID AS FLOAT) AS BIGINT)      -- MODIFICADO   NUMERIC(15,0)  DECIMAL(11,2)
    AND 
    APSA.CLASS = 'CM'  

  )--2360
  INNER JOIN [FUSION].[OCI_RA_CUST_TRX_TYPES_ALL] AS RCTTA ON (
    CAST(CAST(RCTTA.CUST_TRX_TYPE_SEQ_ID AS FLOAT) AS BIGINT) = CAST(CAST(RCTA.CUST_TRX_TYPE_SEQ_ID AS FLOAT) AS BIGINT) 
  )--9440DE
  INNER JOIN [FUSION].[OCI_HZ_CUST_SITE_USES_ALL] AS HCSUA ON (
    CAST(CAST(RCTA.BILL_TO_SITE_USE_ID AS FLOAT) AS BIGINT) = CAST(CAST(HCSUA.SITE_USE_ID AS FLOAT) AS BIGINT)
  )--34400
  INNER JOIN [FUSION].[OCI_HZ_CUST_ACCT_SITES_ALL] AS HCASA ON (
    CAST(CAST(HCSUA.CUST_ACCT_SITE_ID AS FLOAT) AS BIGINT) = CAST(CAST(HCASA.CUST_ACCT_SITE_ID AS FLOAT) AS BIGINT) 
  )--127520
  INNER JOIN [FUSION].[OCI_HZ_PARTY_SITES] AS RA ON (
    CAST(CAST(HCASA.PARTY_SITE_ID AS FLOAT) AS BIGINT) = CAST(CAST(RA.PARTY_SITE_ID AS FLOAT) AS BIGINT)
    AND 
    HCA.ATTRIBUTE_CATEGORY = 'DCMS - PJ'--RA.GLOBAL_ATTRIBUTE2 = '2'
    AND
    CAST(CAST(HCASA.SET_ID AS FLOAT) AS BIGINT)   IN (300000011186631,300000011186633) --RA.PARTY_SITE_ID IN( 104, 182)
  )--8040960
   INNER JOIN MTL /*[FUSION].[OCI_EGP_ITEM_RELATIONSHIPS_B]*/ AS MSI ON  (
      CAST(CAST(MSI.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT) = CAST(CAST(RCTLA.INVENTORY_ITEM_ID AS FLOAT) AS BIGINT)--MSI.INVENTORY_ITEM_ID = CAST(RCTLA.INVENTORY_ITEM_ID AS NUMERIC(18,0))   -- MODIFICADO   NUMERIC(18,0)   DECIMAL(38,18)
      AND 
      CAST(CAST(MSI.ORGANIZATION_ID AS FLOAT) AS BIGINT) = 300000011226455 -- 107
      AND
      SUBSTRING(MSI.CROSS_REFERENCE,1,1) in ('0','1','2','3','4','5','6','7','8','9')
  )-- 2010240                                                                           -- VERIFICAR SE O CORRETO SERIA LEFT OU INNER
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_PLANO] AS TP ON (
        CAST(REPLICATE('0', 11 -LEN(TP.CD_PLANO))+RTrim(TP.CD_PLANO) AS VARCHAR) = CAST(REPLICATE('0', 11 -LEN(MSI.CROSS_REFERENCE))+RTrim(MSI.CROSS_REFERENCE) AS VARCHAR)
)--1005120
  WHERE
  CAST(CAST(RCTA.ORG_ID AS FLOAT) AS BIGINT) IN(300000005902285, 300000005902311)  --( 104, 182)
    AND
    CAST(CAST(RCTA.PREVIOUS_CUSTOMER_TRX_ID AS FLOAT) AS BIGINT) IS NOT NULL
 AND 
     FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'yyyy-MM-dd')  BETWEEN FORMAT(CONVERT(DATETIME,@c_dStartDate), 'yyyy-MM-dd')
                                            AND FORMAT(CONVERT(DATETIME,@c_dEndDate) ,'yyyy-MM-dd') -- 92160
                                            --FORMAT(CONVERT(DATETIME,RCTA.TRX_DATE),'yyyy')   
 GROUP BY
    GCC.SEGMENT1
    ,ME.NM_MARCA
    ,CEL.NM_CELULA
    ,ME.CD_EMPRESA_GESTORA
    ,MSI.CROSS_REFERENCE
    ,TE.ID_EMPRESA_PF
    ,RCTLA.ATTRIBUTE14
    ,HCA.ACCOUNT_NUMBER
    ,RCTLGDA.GL_DATE
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN 'ODPV'
            WHEN '05'   THEN 'BBDENTAL'
        ELSE 'OUTRO'
        END                                                       +
      CASE GCC.SEGMENT1
            WHEN '01'   THEN '30194-9'
            WHEN '05'   THEN '41941-9'
        ELSE 'OUTRO'
        END                                                       +
      '4'                                                         +
      HCA.ACCOUNT_NUMBER                                          +
      RCTA.TRX_NUMBER                                             +
      COALESCE(CAST(MSI.CROSS_REFERENCE AS NVARCHAR),'')          +
      COALESCE(RCTLA.ATTRIBUTE14,'')                              +
      '-' + GCC.SEGMENT4                                          +
      '-' + FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'ddMMyyyy') +
      '-CAN-PJ' 
      ,RCTA.TRX_NUMBER
    ,TE.CD_EMPRESA                                                +
    COALESCE(TRY_CAST(MSI.CROSS_REFERENCE AS INT),'') 
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN 'ODPV'
            WHEN '05'   THEN 'BBDT'
        ELSE 'OUTRO'
        END 
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN '30194-9'
            WHEN '05'   THEN '41941-9'
        ELSE 'OUTRO'
        END 
    ,COALESCE(CAST(MSI.CROSS_REFERENCE AS NVARCHAR),'')
    ,MSI.DESCRIPTION 
    ,FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'yyyy') 
    ,FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'MM') 
    ,GCC.SEGMENT4
    ,CONCAT(HCA.ACCOUNT_NUMBER,'0') 
    ,FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE),'ddMMyyyy')
    ,CASE
          WHEN TE.ID_EMPRESA_PF = 'S' THEN 'PF'
          WHEN UPPER(ME.NM_MARCA) LIKE UPPER('%PME%') THEN 'PME'
          WHEN (
                  ME.CD_EMPRESA_GESTORA = 15 
                  AND 
                  UPPER(TRIM(ME.NM_MARCA)) = 'BBDENTAL' 
                  AND 
                  UPPER(CEL.NM_CELULA) LIKE UPPER('Núcleo de Atendimento PJ%')                                
                  ) THEN 'PME'           
          ELSE
              'CORP'
      END 
    ,TE.CD_EMPRESA_GRSOC 
    ,TE.CD_EMPRESA 
    ,TP.ID_RISCO_CEDIDO 
    ,REPLACE(TE.CD_EMPRESA_CLI_OPERADORA, 'ODSY', '')
;
