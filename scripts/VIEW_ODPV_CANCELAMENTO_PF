--VIEW_ODPV_CANCELAMENTO_PF
INSERT INTO IFRS17.TB_ODPV_BBDT_PREMIO_MOVIMENTO_HML
SELECT  
    'ODPV'                                                            AS MNEMONICO
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN 'ODPV'
            WHEN '05'   THEN 'BBDENTAL'
        ELSE 'OUTRO'
        END                                                     +
      CASE GCC.SEGMENT1
            WHEN '01'   THEN '30194-9'
            WHEN '05'   THEN '41941-9'
        ELSE 'OUTRO'
        END                                                      +
      '4'                                                         +
      HCA.ACCOUNT_NUMBER                                          +
      RCTA.TRX_NUMBER                                             +
      COALESCE(CAST(MSI.CROSS_REFERENCE AS NVARCHAR),'')          +
      COALESCE(RCTLA.ATTRIBUTE14,'')                              +
      '-' + GCC.SEGMENT4                                          +
      '-' + FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'ddMMyyyy') +
      '-CAN-PF'                                                       AS INSTID
      ,RCTA.TRX_NUMBER                                                AS FATURA
    ,CAST(TE.CD_EMPRESA AS NVARCHAR)                              +
      CAST(COALESCE(CAST(MSI.CROSS_REFERENCE AS BIGINT),'') AS NVARCHAR) +
      TA.NR_ATENDIMENTO                                               AS CONTRATO_PLANO
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN 'ODPV'
            WHEN '05'   THEN 'BBDT'
        ELSE 'OUTRO'
        END                                                           AS CD_COMPANHIA
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN '30194-9'
            WHEN '05'   THEN '41941-9'
        ELSE 'OUTRO'
        END                                                           AS CD_ENTIDADE
    ,'4'                                                              AS CD_RAMO 
    ,''                                                               AS CD_SUBRAMO
    ,CAST(COALESCE(CAST(MSI.CROSS_REFERENCE AS BIGINT),'') AS NVARCHAR)      AS CD_PRODUTO
    ,'ODONTOLOGICO'                                                   AS NM_RAMO
    ,''                                                               AS NM_SUBRAMO
    ,MSI.DESCRIPTION                                                  AS NM_PRODUTO
    ,FORMAT(RCTLGDA.GL_DATE, 'yyyy')                                  AS ANO_CONTABIL
    ,FORMAT(RCTLGDA.GL_DATE, 'MM')                                    AS MES_CONTABIL
    ,'CANCELAMENTO'                                                   AS TIPO_MOVIMENTO
    ,GCC.SEGMENT4                                                     AS CD_CONTA_CONTABIL
    ,CONCAT(HCA.ACCOUNT_NUMBER,'0')                                   AS ENDOSSO
    ,CAST(SUM(RCTLA.EXTENDED_AMOUNT) AS DECIMAL (22,2))               AS VALOR_MOVIMENTO
    ,CONVERT(VARCHAR,RCTLGDA.GL_DATE,103)                             AS DT_MOVIMENTO
    ,CASE
          WHEN TE.ID_EMPRESA_PF = 'S' THEN 'PF'
          WHEN UPPER(ME.NM_MARCA) LIKE UPPER('%PME%') THEN 'PME'
          WHEN (
                  ME.CD_EMPRESA_GESTORA = '15' 
                  AND 
                  UPPER(TRIM(ME.NM_MARCA)) = 'BBDENTAL' 
                  AND 
                  UPPER(CEL.NM_CELULA) LIKE UPPER('Núcleo de Atendimento PJ%')                                
                  ) THEN 'PME'           
          ELSE
              'CORP'
      END                                                             AS PORTFOLIO
    ,TE.CD_EMPRESA_GRSOC                                              AS GRUPO_GERENCIAL
    ,TE.CD_EMPRESA                                                    AS CD_EMPRESA 
    ,TP.ID_RISCO_CEDIDO                                               AS RISCO_CEDIDO
    ,REPLACE(TE.CD_EMPRESA_CLI_OPERADORA, 'ODSY', '')                 AS CD_CLI_OPERADORA 
  FROM [FUSION].[OCI_RA_CUSTOMER_TRX_ALL] AS RCTA
  INNER JOIN [FUSION].[OCI_HZ_CUST_ACCOUNTS] AS HCA ON (
    HCA.CUST_ACCOUNT_ID = RCTA.BILL_TO_CUSTOMER_ID
  )
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_ASSOCIADO] AS TA ON (
    TRIM(HCA.ACCOUNT_NUMBER) = TRIM(TA.CD_ASSOCIADO)                   
  )
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_EMPRESA] AS TE ON (
        TE.CD_EMPRESA = CAST(TA.CD_EMPRESA AS INT)                         -- MODIFICADO   INT   NVARCHAR(6)
  )
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_MARCA_EMPRESA] AS ME ON (
    ME.CD_MARCA  = TE.CD_MARCA
    AND
    ME.CD_EMPRESA_GESTORA IN (1, 15)
  )
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_CELULA] AS CEL ON (
    CAST(CEL.CD_CELULA AS INT) = TE.CD_CELULA                             -- MODIFICADO   DECIMAL(38,18)  INT
  )
  INNER JOIN [FUSION].[OCI_RA_CUSTOMER_TRX_LINES_ALL] AS RCTLA ON (
    RCTA.CUSTOMER_TRX_ID = RCTLA.CUSTOMER_TRX_ID   -- MODIFICADO   NUMERIC(15,0)   DECIMAL(38,18)
    AND 
    RCTLA.LINE_TYPE = 'LINE'
    AND
    RCTLA.INVENTORY_ITEM_ID  IS NOT NULL
  )
  INNER JOIN [FUSION].[OCI_RA_CUST_TRX_LINE_GL_DIST_ALL] AS RCTLGDA ON (
    RCTLA.CUSTOMER_TRX_LINE_ID  = RCTLGDA.CUSTOMER_TRX_LINE_ID
  )
  INNER JOIN [FUSION].[OCI_GL_CODE_COMBINATIONS] AS GCC ON (
    CAST(CAST(RCTLGDA.CODE_COMBINATION_ID AS FLOAT) AS BIGINT) = CAST(CAST(GCC.CODE_COMBINATION_ID AS FLOAT) AS BIGINT) -- MODIFICADO   DECIMAL(38,18)  NUMERIC(15,0)   
  )
  INNER JOIN [FUSION].[OCI_AR_PAYMENT_SCHEDULES_ALL] AS APSA ON (
    CAST(CAST(RCTA.CUSTOMER_TRX_ID AS FLOAT) AS BIGINT) = CAST(CAST(APSA.CUSTOMER_TRX_ID AS FLOAT) AS BIGINT)  -- MODIFICADO   NUMERIC(15,0)  DECIMAL(11,2)
    AND 
    APSA.CLASS = 'CM'  
  )
  INNER JOIN [FUSION].[OCI_RA_CUST_TRX_TYPES_ALL] AS RCTTA ON (
    RCTTA.CUST_TRX_TYPE_ID = RCTA.CUST_TRX_TYPE_ID 
  )
  INNER JOIN [FUSION].[OCI_HZ_CUST_SITE_USES_ALL] AS HCSUA ON (
    RCTA.BILL_TO_SITE_USE_ID = HCSUA.SITE_USE_ID 
  )
  INNER JOIN [FUSION].[OCI_HZ_CUST_ACCT_SITES_ALL] AS HCASA ON (
    HCSUA.CUST_ACCT_SITE_ID = HCASA.CUST_ACCT_SITE_ID 
  )
  INNER JOIN [FUSION].[OCI_HZ_PARTY_SITES] AS RA ON (
    HCASA.PARTY_SITE_ID = RA.PARTY_SITE_ID
    AND 
    HCA.ATTRIBUTE_CATEGORY = 'DCMS - PF'
    AND
    CAST(CAST(HCASA.SET_ID AS FLOAT) AS BIGINT)   IN (300000011186631,300000011186633)
  )
  INNER JOIN [FUSION].[APPS_MTL_SYSTEM_ITEMS_B] AS MSI ON (
    MSI.INVENTORY_ITEM_ID = CAST(RCTLA.INVENTORY_ITEM_ID AS NUMERIC(18,0))   -- MODIFICADO   NUMERIC(18,0)   DECIMAL(38,18)
    AND 
    MSI.ORGANIZATION_ID = 107
    AND
    SUBSTRING(MSI.CROSS_REFERENCE,1,1) in ('0','1','2','3','4','5','6','7','8','9')
  )                                                                            -- VERIFICAR SE O CORRETO SERIA LEFT OU INNER
  INNER JOIN [DCMS_HML].[ADMPROD_TBOD_PLANO] AS TP ON (
        CAST(REPLICATE('0', 11 -LEN(TP.CD_PLANO))+RTrim(TP.CD_PLANO) AS NVARCHAR) = MSI.CROSS_REFERENCE    -- MODIFICADO INT    NVARCHAR(40)
  )
  WHERE
    CAST(CAST(RCTA.ORG_ID AS FLOAT) AS BIGINT) IN(300000005902285, 300000005902311)--RCTA.ORG_ID IN( 104, 182)
    AND
    RCTA.PREVIOUS_CUSTOMER_TRX_ID IS NOT NULL
 AND 
     FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'yyyy-MM-dd')  BETWEEN FORMAT(CONVERT(DATETIME,@c_dStartDate), 'yyyy-MM-dd')
                                             AND FORMAT(CONVERT(DATETIME,@c_dEndDate) ,'yyyy-MM-dd') 
  GROUP BY
    CASE GCC.SEGMENT1
            WHEN '01'   THEN 'ODPV'
            WHEN '05'   THEN 'BBDENTAL'
        ELSE 'OUTRO'
        END                                                     +
      CASE GCC.SEGMENT1
            WHEN '01'   THEN '30194-9'
            WHEN '05'   THEN '41941-9'
        ELSE 'OUTRO'
        END                                                     +
      '4'                                                       +
      HCA.ACCOUNT_NUMBER                                        +
      RCTA.TRX_NUMBER                                           +
      CAST(COALESCE(CAST(MSI.CROSS_REFERENCE AS BIGINT),'') AS NVARCHAR)  +
      COALESCE(RCTLA.ATTRIBUTE14,'')                            +
      '-' + GCC.SEGMENT4                                        +
      '-' + FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'yyyy-MM-dd')                 +
      '-CAN-PF'
      ,RCTA.TRX_NUMBER
    ,CAST(TE.CD_EMPRESA AS NVARCHAR)                            +
      CAST(COALESCE(CAST(MSI.CROSS_REFERENCE AS BIGINT),'') AS NVARCHAR)  +
      TA.NR_ATENDIMENTO 
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN 'ODPV'
            WHEN '05'   THEN 'BBDT'
        ELSE 'OUTRO'
        END 
    ,CASE GCC.SEGMENT1
            WHEN '01'   THEN '30194-9'
            WHEN '05'   THEN '41941-9'
        ELSE 'OUTRO'
        END 
    ,CAST(COALESCE(CAST(MSI.CROSS_REFERENCE AS BIGINT),'') AS NVARCHAR) 
    ,MSI.DESCRIPTION 
    ,FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'yyyy')                
    ,FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'MM')                  
    ,GCC.SEGMENT4 
    ,CONCAT(HCA.ACCOUNT_NUMBER,'0') 
    ,FORMAT(CONVERT(DATETIME,RCTLGDA.GL_DATE), 'yyyy-MM-dd') 
    ,CASE
          WHEN TE.ID_EMPRESA_PF = 'S' THEN 'PF'
          WHEN UPPER(ME.NM_MARCA) LIKE UPPER('%PME%') THEN 'PME'
          WHEN (
                  ME.CD_EMPRESA_GESTORA = '15' 
                  AND 
                  UPPER(TRIM(ME.NM_MARCA)) = 'BBDENTAL' 
                  AND 
                  UPPER(CEL.NM_CELULA) LIKE UPPER('Núcleo de Atendimento PJ%')                                
                  ) THEN 'PME'           
          ELSE
              'CORP'
      END  
    ,TE.CD_EMPRESA_GRSOC 
    ,TE.CD_EMPRESA 
    ,TP.ID_RISCO_CEDIDO 
    ,REPLACE(TE.CD_EMPRESA_CLI_OPERADORA, 'ODSY', '')
;
